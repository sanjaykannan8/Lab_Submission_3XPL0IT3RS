name: Publish Approved Labs

on:
  issues:
    types:
      - labeled

jobs:
  publish:
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --production

      - name: Publish lab to Firestore
        run: npm run publish-lab
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_HTML_URL: ${{ github.event.issue.html_url }}
          ISSUE_CREATED_AT: ${{ github.event.issue.created_at }}
          ISSUE_USER_LOGIN: ${{ github.event.issue.user.login }}
          APPROVED_BY_LOGIN: ${{ github.actor }}

      - name: Update issue state
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const labelsToRemove = ['pending-review'];
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  name: label,
                });
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }
              }
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: ['published'],
            });

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                'This lab has been approved and published to Firestore.',
                '',
                '- It is now visible on the Labs page.',
                '- Solutions remain hidden until users spend points to unlock them.',
                '',
                'Thanks for contributing!',
              ].join('\n'),
            });

