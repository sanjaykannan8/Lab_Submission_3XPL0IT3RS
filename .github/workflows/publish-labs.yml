name: Publish Approved Labs

on:
  issues:
    types:
      - labeled

jobs:
  publish:
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --production

      - name: Publish lab to Firestore
        run: npm run publish-lab
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_HTML_URL: ${{ github.event.issue.html_url }}
          ISSUE_CREATED_AT: ${{ github.event.issue.created_at }}
          ISSUE_USER_LOGIN: ${{ github.event.issue.user.login }}
          APPROVED_BY_LOGIN: ${{ github.actor }}

      - name: Secure and close issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Add success comment
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issueNumber,
              body: [
                'âœ… **Lab Approved & Published!**',
                '',
                'Your challenge has been successfully published to Firestore.',
                '',
                '- âœ¨ Now live on the Labs page',
                '- ðŸ”’ Flag stored securely (hashed)',
                '- ðŸŽ¯ Solutions locked behind points',
                '',
                'âš ï¸ **Security Notice:** The issue body will be cleared in 5 seconds to protect the flag.',
                '',
                'Thanks for contributing! ðŸš€',
              ].join('\n'),
            });

            // Wait 5 seconds to allow comment to be read
            await new Promise(resolve => setTimeout(resolve, 5000));

            // Clear the issue body to remove flag and sensitive data
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: issueNumber,
              state: 'closed',
              body: [
                '# Lab Published âœ…',
                '',
                'This challenge has been approved and published.',
                '',
                '**Original content removed for security reasons (contained flag).**',
                '',
                'The lab is now live on the platform with the flag stored securely.',
              ].join('\n'),
            });

            // Lock the issue to prevent further modifications
            await github.rest.issues.lock({
              owner,
              repo,
              issue_number: issueNumber,
              lock_reason: 'resolved',
            });

            console.log(`âœ… Issue #${issueNumber} secured: body cleared, closed, and locked`);

